from typing import List, Optional

from chia.types.blockchain_format.program import Program
from chia.types.coin_spend import CoinSpend
from chia.types.spend_bundle import SpendBundle
from chia.wallet.trading.offer import ZERO_32

from chia_rs import G2Element

from partial_cli.utils.rpc import is_coin_spent

# partial.clsp
MOD = Program.fromhex(
    "0xff02ffff01ff04ffff04ffff0149ffff04ff8205ffff808080ffff02ffff03ffff15ff822fffff8080ffff01ff04ffff02ffff03ffff15ffff11ff8205ffff822fff80ff8080ffff01ff04ffff0133ffff04ff8217ffffff04ffff11ff8205ffff822fff80ff80808080ffff01ff04ffff0101ff808080ff0180ffff04ffff04ffff0146ffff04ff820bffff808080ffff04ffff02ff26ffff04ff02ffff04ff8200bfffff04ff8217ffff8080808080ffff04ffff02ff36ffff04ff02ffff04ff2fffff04ff82017fffff04ff820bffffff04ffff02ff2affff04ff02ffff04ff8202ffffff04ff8200bfffff04ff82017fffff04ff822fffff80808080808080ff80808080808080ffff04ffff02ff2effff04ff02ffff04ffff11ff822fffffff02ff3affff04ff02ffff04ff17ffff04ff822fffff808080808080ff80808080ffff04ffff04ffff0133ffff04ff0bffff04ffff02ff3affff04ff02ffff04ff17ffff04ff822fffff8080808080ff80808080ff80808080808080ffff01ff02ff3effff04ff02ffff04ff2fffff04ff5fffff04ff8205ffffff04ff825fffff8080808080808080ff018080ffff04ffff01ffffffff0bffff0102ffff0bffff0102ffff06ffff05ffff01ffffa04bf5122f344554c53bde2ebb8cd2b7e3d1600ad631c385a5d7cce23c7785459aa09dcf97a184f32623d11a73124ceb99a5709b083721e878a16d78f596718ba7b2ffa102a12871fee210fb8619291eaea194581cbd2531e4b23759d225f6806923f63222a102a8d5dd63fba471ebcb1f3e8f7c1e1879b7152a6e7298a91ce119a63400ade7c58080ff0580ffff0bffff0102ff0bffff05ffff05ffff01ffffa04bf5122f344554c53bde2ebb8cd2b7e3d1600ad631c385a5d7cce23c7785459aa09dcf97a184f32623d11a73124ceb99a5709b083721e878a16d78f596718ba7b2ffa102a12871fee210fb8619291eaea194581cbd2531e4b23759d225f6806923f63222a102a8d5dd63fba471ebcb1f3e8f7c1e1879b7152a6e7298a91ce119a63400ade7c580808080ffff02ffff03ff05ffff01ff0bffff06ffff06ffff01ffffa04bf5122f344554c53bde2ebb8cd2b7e3d1600ad631c385a5d7cce23c7785459aa09dcf97a184f32623d11a73124ceb99a5709b083721e878a16d78f596718ba7b2ffa102a12871fee210fb8619291eaea194581cbd2531e4b23759d225f6806923f63222a102a8d5dd63fba471ebcb1f3e8f7c1e1879b7152a6e7298a91ce119a63400ade7c58080ffff02ff10ffff04ff02ffff04ff09ffff04ffff02ff28ffff04ff02ffff04ff0dff80808080ff808080808080ffff01ff06ffff05ffff01ffffa04bf5122f344554c53bde2ebb8cd2b7e3d1600ad631c385a5d7cce23c7785459aa09dcf97a184f32623d11a73124ceb99a5709b083721e878a16d78f596718ba7b2ffa102a12871fee210fb8619291eaea194581cbd2531e4b23759d225f6806923f63222a102a8d5dd63fba471ebcb1f3e8f7c1e1879b7152a6e7298a91ce119a63400ade7c5808080ff0180ff0bffff05ffff06ffff01ffffa04bf5122f344554c53bde2ebb8cd2b7e3d1600ad631c385a5d7cce23c7785459aa09dcf97a184f32623d11a73124ceb99a5709b083721e878a16d78f596718ba7b2ffa102a12871fee210fb8619291eaea194581cbd2531e4b23759d225f6806923f63222a102a8d5dd63fba471ebcb1f3e8f7c1e1879b7152a6e7298a91ce119a63400ade7c58080ffff02ff10ffff04ff02ffff04ff05ffff04ffff02ff28ffff04ff02ffff04ff07ff80808080ff808080808080ffff02ffff03ffff07ff0580ffff01ff0bffff0102ffff02ff14ffff04ff02ffff04ff09ff80808080ffff02ff14ffff04ff02ffff04ff0dff8080808080ffff01ff0bffff0101ff058080ff0180ffff05ffff14ffff12ff05ff0b80ffff018600e8d4a510008080ff12ff05ff0b80ffffff05ffff14ffff12ff05ff0b80ffff018600e8d4a510008080ffff02ffff03ff0bffff01ff02ffff03ff17ffff01ff02ff12ffff04ff02ffff04ff05ffff04ff2fff8080808080ffff01ff02ff3cffff04ff02ffff04ff05ffff04ff2fff808080808080ff0180ffff01ff02ff2cffff04ff02ffff04ff05ffff04ff2fff808080808080ff0180ff05ffff14ffff12ff05ff0b80ffff018227108080ffffff04ffff0148ffff04ffff02ffff03ff05ffff01ff02ff38ffff04ff02ffff04ffff01a037bef360ee858133b69d595a906dc45d01af50379dad515eb9518abb7c1d2a7affff04ffff0bffff0101ffff01a037bef360ee858133b69d595a906dc45d01af50379dad515eb9518abb7c1d2a7a80ffff04ffff0bffff0101ff0580ffff04ff0bff80808080808080ffff010b80ff0180ff808080ff04ffff013fffff04ffff0bffff02ffff03ff0bffff01ff02ff38ffff04ff02ffff04ffff01a037bef360ee858133b69d595a906dc45d01af50379dad515eb9518abb7c1d2a7affff04ffff0bffff0101ffff01a037bef360ee858133b69d595a906dc45d01af50379dad515eb9518abb7c1d2a7a80ffff04ffff0bffff0101ff0b80ffff04ffff01a0cfbfdeed5c4ca2de3d0bf520b9cb4bb7743a359bd2e6a188d19ce7dffc21d3e7ff80808080808080ffff01ff01a0cfbfdeed5c4ca2de3d0bf520b9cb4bb7743a359bd2e6a188d19ce7dffc21d3e780ff0180ffff02ff14ffff04ff02ffff04ffff04ff17ffff04ffff04ff05ffff04ff2fffff04ffff04ff05ff8080ff80808080ff808080ff8080808080ff808080ffff04ffff0133ffff04ffff01a0cfbfdeed5c4ca2de3d0bf520b9cb4bb7743a359bd2e6a188d19ce7dffc21d3e7ffff04ff05ff80808080ff04ffff02ffff03ffff15ff2fff8080ffff01ff04ffff0134ffff04ff2fff808080ffff01ff04ffff0101ff808080ff0180ffff04ffff04ffff0133ffff04ff05ffff04ff17ff80808080ffff04ffff04ffff0132ffff04ff0bffff04ffff0bff1780ff80808080ff80808080ff018080"
)
MOD_HASH = MOD.get_tree_hash()

# fee.clsp
FEE_MOD = Program.fromhex(
    "0xff02ffff01ff02ff02ffff04ff02ffff04ff05ffff04ff0bff8080808080ffff04ffff01ff05ffff14ffff12ff05ff0b80ffff018227108080ff018080"
)

# rate.clsp
RATE_MOD = Program.fromhex(
    "0xff02ffff01ff02ff02ffff04ff02ffff04ff05ffff04ff0bffff04ff17ffff04ff2fff80808080808080ffff04ffff01ff02ffff03ff05ffff01ff02ffff03ff0bffff01ff0880ffff01ff05ffff14ff2fff17808080ff0180ffff01ff05ffff14ffff12ff2fffff018600e8d4a5100080ff17808080ff0180ff018080"
)


def get_partial_coin_spend(coin_spends: List[CoinSpend]) -> Optional[CoinSpend]:
    return next(
        (
            cs
            for cs in coin_spends
            if cs.solution.to_program() == Program.to(["dexie_partial"])
        ),
        None,
    )


def get_non_partial_coin_spends(coin_spends: List[CoinSpend]) -> List[CoinSpend]:
    return list(
        filter(
            lambda cs: (
                cs.solution.to_program() != Program.to(["dexie_partial"])
                and cs.coin.parent_coin_info != ZERO_32
            ),
            coin_spends,
        )
    )


async def get_create_offer_coin_sb(
    coin_spends: List[CoinSpend], aggregated_signature: G2Element
) -> Optional[SpendBundle]:
    non_partial_coin_spends = get_non_partial_coin_spends(coin_spends)
    if len(non_partial_coin_spends) == 0:
        return None

    for cs in non_partial_coin_spends:
        is_spent = await is_coin_spent(cs.coin.name())
        if is_spent:
            return None

    return SpendBundle(non_partial_coin_spends, aggregated_signature)
